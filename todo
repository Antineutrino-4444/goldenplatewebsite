CREATE TABLE schools (
    id          TEXT PRIMARY KEY,
    name        TEXT NOT NULL,
    slug        TEXT NOT NULL UNIQUE,
    created_at  DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
    updated_at  DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP
);

CREATE TABLE users (
    id              TEXT PRIMARY KEY,
    school_id       TEXT NOT NULL REFERENCES schools(id) ON DELETE CASCADE,
    username        TEXT NOT NULL,
    password_hash   TEXT NOT NULL,
    display_name    TEXT NOT NULL,
    role            TEXT NOT NULL
                      CHECK (role IN ('user','admin','superadmin', 'inter_school')),
    last_login_at   DATETIME,
    created_at      DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
    updated_at      DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
    UNIQUE (school_id, username)
);
CREATE INDEX idx_users_school ON users (school_id);

CREATE TABLE user_invite_codes (
    id          TEXT PRIMARY KEY,
    school_id   TEXT NOT NULL REFERENCES schools(id) ON DELETE CASCADE,
    user_id     TEXT NOT NULL REFERENCES users(id) ON DELETE CASCADE,
    code        TEXT NOT NULL,
    issued_by   TEXT NOT NULL REFERENCES users(id),
    issued_at   DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
    expires_at  DATETIME,
    used_by     TEXT REFERENCES users(id),
    used_at     DATETIME,
    status      TEXT NOT NULL DEFAULT 'unused'
                  CHECK (status IN ('unused','used','revoked')),
    UNIQUE (school_id, code)
);

CREATE TABLE school_invite_codes(
    id          TEXT PRIMARY KEY,
    school_id   TEXT NOT NULL REFERENCES schools(id) ON DELETE CASCADE,
    code        TEXT NOT NULL,
    issued_by   TEXT NOT NULL REFERENCES users(id),
    issued_at   DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
    expires_at  DATETIME,
    used_by     TEXT REFERENCES users(id),
    used_at     DATETIME,
    status      TEXT NOT NULL DEFAULT 'unused'
                  CHECK (status IN ('unused','used','revoked')),
    UNIQUE (school_id, code)
)

CREATE INDEX idx_invite_codes_school ON user_invite_codes (school_id);
CREATE INDEX idx_invite_codes_user ON user_invite_codes (user_id, status);

CREATE TABLE students (
    id                  TEXT PRIMARY KEY,
    school_id           TEXT NOT NULL REFERENCES schools(id) ON DELETE CASCADE,
    student_identifier  TEXT NOT NULL,
    preferred_name      TEXT NOT NULL,
    last_name           TEXT NOT NULL,
    grade               TEXT,
    advisor             TEXT,
    house               TEXT,
    clan                TEXT,
    UNIQUE (school_id, student_identifier)
);
CREATE INDEX idx_students_school ON students (school_id);

CREATE TABLE teachers (
    id          TEXT PRIMARY KEY,
    school_id   TEXT NOT NULL REFERENCES schools(id) ON DELETE CASCADE,
    name        TEXT NOT NULL,
    display_name TEXT,
    UNIQUE (school_id, name)
);
CREATE INDEX idx_teachers_school ON teachers (school_id);

CREATE TABLE sessions (
    id             TEXT PRIMARY KEY,
    school_id      TEXT NOT NULL REFERENCES schools(id) ON DELETE CASCADE,
    created_by     TEXT NOT NULL REFERENCES users(id),
    session_name   TEXT NOT NULL,
    status         TEXT NOT NULL DEFAULT 'active'
                     CHECK (status IN ('active','archived','discarded')),
    is_public      INTEGER NOT NULL DEFAULT 1,
    created_at     DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
    updated_at     DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
    discarded_at   DATETIME,
    discarded_by   TEXT REFERENCES users(id),

    clean_number     INTEGER,
    dirty_number     INTEGER,
    red_number       INTEGER,
    faculty_number   INTEGER,

    total_records   INTEGER,
    total_clean     INTEGER,
    total_dirty     INTEGER,

    draw_number           INTEGER NOT NULL DEFAULT 1,
    winner_student_id     TEXT REFERENCES students(id),
    method                TEXT,
    finalized             INTEGER NOT NULL DEFAULT 0,
    finalized_by          TEXT REFERENCES users(id),
    finalized_at          DATETIME,
    tickets_at_selection  REAL,
    probability_at_selection REAL,
    eligible_pool_size    INTEGER,
    override_applied      INTEGER NOT NULL DEFAULT 0,
    UNIQUE (school_id, session_name)
);
CREATE INDEX idx_sessions_school ON sessions (school_id);

CREATE TABLE session_records (
    id                TEXT PRIMARY KEY,
    school_id         TEXT NOT NULL REFERENCES schools(id) ON DELETE CASCADE,
    session_id        TEXT NOT NULL REFERENCES sessions(id) ON DELETE CASCADE,
    student_id        TEXT REFERENCES students(id),
    category          TEXT NOT NULL
                         CHECK (category IN ('clean','dirty','red','faculty')),
    grade             TEXT,
    house             TEXT,
    is_manual_entry   INTEGER NOT NULL DEFAULT 0,
    recorded_by       TEXT NOT NULL REFERENCES users(id),
    recorded_at       DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
    dedupe_key        TEXT NOT NULL,
    UNIQUE (school_id, session_id, dedupe_key)
);
CREATE INDEX idx_records_school_session_category ON session_records (school_id, session_id, category);

CREATE TABLE session_draw_events (
    id                    TEXT PRIMARY KEY,
    school_id             TEXT NOT NULL REFERENCES schools(id) ON DELETE CASCADE,
    session_id            TEXT NOT NULL REFERENCES sessions(id) ON DELETE CASCADE,
    draw_number           INTEGER,
    event_type            TEXT NOT NULL
                             CHECK (event_type IN ('draw','override','finalize','restore')),
    selected_record_id    TEXT REFERENCES session_records(id),
    selected_student_id   TEXT REFERENCES students(id),
    tickets_at_event      REAL,
    probability_at_event  REAL,
    eligible_pool_size    INTEGER,
    created_at            DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
    created_by            TEXT REFERENCES users(id)
);
CREATE INDEX idx_draw_events_school_session ON session_draw_events (school_id, session_id, created_at);


CREATE TABLE session_ticket_events (
    id                    TEXT PRIMARY KEY,
    school_id             TEXT NOT NULL REFERENCES schools(id) ON DELETE CASCADE,
    session_id            TEXT NOT NULL REFERENCES sessions(id) ON DELETE CASCADE,
    session_record_id     TEXT REFERENCES session_records(id) ON DELETE SET NULL,
    student_id            TEXT REFERENCES students(id),
    event_type            TEXT NOT NULL
                             CHECK (event_type IN ('earn','reset','manual_adjust')),
    tickets_delta         REAL NOT NULL,
    ticket_balance_after  REAL,
    occurred_at           DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
    occurred_by           TEXT REFERENCES users(id),
    metadata              TEXT
);
CREATE INDEX idx_ticket_events_school_session ON session_ticket_events (school_id, session_id, occurred_at);

CREATE TABLE draft_pool (
    id             TEXT PRIMARY KEY,
    school_id      TEXT NOT NULL REFERENCES schools(id) ON DELETE CASCADE,
    session_id     TEXT REFERENCES sessions(id) ON DELETE CASCADE,
    student_id     TEXT REFERENCES students(id),
    ticket_number  REAL NOT NULL
);
CREATE INDEX idx_draft_pool_school_session ON draft_pool (school_id, session_id);

CREATE TABLE session_delete_requests (
    id                       TEXT PRIMARY KEY,
    school_id                TEXT NOT NULL REFERENCES schools(id) ON DELETE CASCADE,
    session_id               TEXT NOT NULL REFERENCES sessions(id) ON DELETE CASCADE,
    requested_by             TEXT NOT NULL REFERENCES users(id),
    requested_at             DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
    status                   TEXT NOT NULL DEFAULT 'pending'
                               CHECK (status IN ('pending','approved','rejected','completed')),
    reviewed_by              TEXT REFERENCES users(id),
    reviewed_at              DATETIME,
    rejection_reason         TEXT
);
CREATE INDEX idx_delete_requests_school_session ON session_delete_requests (school_id, session_id);


Inter school logic
the interschool user logs into a special panel
its only purpose is to manage schools. It cannot view or create sessions
its school id is a 11, which no other school can use,
it can not do anything related to sessions.
It can create invite codes for schools to register, disable schools, view school info